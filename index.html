<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLUMS - Криптобиржа</title>
    <style>
        /* === Десктопные стили === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #0a0e17;
            color: #ffffff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #2a2f3b;
            flex-wrap: wrap;
            gap: 10px;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        nav {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        nav a {
            color: #ffffff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        nav a:hover {
            background-color: #2a2f3b;
        }
        .main-content {
            display: flex;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }
        .tokens-list {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
        }
        .token-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #1a1f2b;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .token-item:hover {
            background-color: #2a2f3b;
        }
        .token-item.active {
            background-color: #2a2f3b;
            border: 1px solid #00ff88;
        }
        .token-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .token-symbol {
            font-size: 20px;
            font-weight: bold;
        }
        .token-price {
            color: #00ff88;
        }
        .token-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.3s;
            white-space: nowrap;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .btn-buy {
            background-color: #00ff88;
            color: #0a0e17;
        }
        .btn-sell {
            background-color: #ff4444;
            color: #ffffff;
        }
        .chart-container {
            flex: 2;
            min-width: 300px;
            background-color: #1a1f2b;
            border-radius: 12px;
            padding: 20px;
            height: 600px;
            position: relative;
        }
        .chart {
            width: 100%;
            height: 100%;
            background-color: #2a2f3b;
            border-radius: 8px;
        }
        .token-details {
            margin-top: 20px;
            padding: 20px;
            background-color: #1a1f2b;
            border-radius: 12px;
        }
        .token-details h2 {
            margin-bottom: 10px;
            color: #00ff88;
        }

        /* === Мобильные стили === */
        @media (max-width: 768px) {
            /* Скрываем десктопные блоки */
            .container, header, .main-content { display: none !important; }
            /* Показываем мобильные блоки */
            .mobile-token-list, .mobile-exchange, .mobile-nav, #mobile-modal-root { display: block !important; }
            body { padding-bottom: 70px !important; }
            /* Мобильная навигация */
            .mobile-nav {
                display: flex;
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                background: #16181e;
                border-top: 1px solid #23242a;
                z-index: 3000;
                height: 64px;
                align-items: center;
                justify-content: center;
                box-shadow: 0 -2px 12px #0003;
            }
            .mobile-nav-items {
                display: flex;
                width: 100%;
                justify-content: space-around;
                align-items: center;
            }
            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-decoration: none;
                color: #888;
                font-size: 13px;
                gap: 3px;
                flex: 1;
                padding: 0 2px;
                transition: color 0.2s;
            }
            .mobile-nav-item.active {
                color: #00ff88;
            }
            .mobile-nav-item i {
                font-size: 22px;
            }
            /* Мобильный список токенов */
            .mobile-token-list {
                background: #0a0e17;
                min-height: 100vh;
                padding-bottom: 80px;
            }
            .mobile-token-list-header {
                font-size: 20px;
                font-weight: 600;
                color: #fff;
                padding: 18px 16px 8px 16px;
            }
            .mobile-token-list-items {
                padding: 0 8px 0 8px;
            }
            .mobile-token-list .token-item {
                background: #16181e;
                border-radius: 14px;
                margin-bottom: 10px;
                padding: 16px 14px;
                display: flex;
                align-items: center;
                cursor: pointer;
                transition: background 0.2s;
            }
            .mobile-token-list .token-item:hover {
                background: #23242a;
            }
            .mobile-token-list .token-symbol {
                font-size: 17px;
                font-weight: 600;
                color: #fff;
            }
            .mobile-token-list .token-price {
                color: #00ff88;
                margin-left: 12px;
                font-size: 15px;
            }
            /* Мобильная биржа */
            .mobile-exchange {
                background: #0a0e17;
                min-height: 100vh;
                padding-bottom: 80px;
            }
            .mobile-topbar {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 16px 12px 8px 12px;
                background: #16181e;
                border-bottom: 1px solid #23242a;
            }
            .mobile-back {
                background: none;
                border: none;
                color: #fff;
                font-size: 22px;
                padding: 0 8px 0 0;
                cursor: pointer;
            }
            .mobile-title {
                font-size: 18px;
                font-weight: 600;
                color: #fff;
            }
            .mobile-bot {
                color: #888;
                font-size: 14px;
                font-weight: 400;
            }
            .mobile-topbar-icons {
                display: flex;
                gap: 8px;
            }
            .mobile-topbar-btn {
                background: none;
                border: none;
                color: #fff;
                font-size: 20px;
                cursor: pointer;
            }
            .mobile-token-card {
                background: #16181e;
                border-radius: 18px;
                margin: 16px 12px 0 12px;
                padding: 16px 12px;
                box-shadow: 0 2px 8px 0 #0002;
            }
            .mobile-token-info {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .mobile-token-avatar {
                width: 44px;
                height: 44px;
                border-radius: 50%;
                border: 2px solid #23242a;
            }
            .mobile-token-name {
                font-size: 18px;
                font-weight: 600;
                color: #fff;
            }
            .mobile-token-sub {
                font-size: 13px;
                color: #888;
            }
            .mobile-share {
                margin-left: auto;
                background: #23242a;
                border: none;
                border-radius: 8px;
                color: #fff;
                font-size: 16px;
                padding: 8px 10px;
                cursor: pointer;
            }
            .mobile-token-supply {
                display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 12px;
            }
            .mobile-token-percent {
                color: #00ff88;
                font-weight: 600;
                font-size: 15px;
            }
            .mobile-token-supply-numbers {
                color: #fff;
                font-size: 14px;
            }
            .mobile-info {
                color: #888;
                font-size: 15px;
                margin-left: 4px;
            }
            .mobile-token-stats {
                margin: 18px 12px 0 12px;
                background: #16181e;
                border-radius: 14px;
                padding: 12px 10px 6px 10px;
            }
            .mobile-token-stats-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 6px;
            }
            .mobile-token-stat-label {
                color: #888;
                font-size: 12px;
            }
            .mobile-token-stat-value {
                color: #fff;
                font-size: 15px;
                font-weight: 600;
            }
            .mobile-token-switches {
                display: flex;
                justify-content: space-between;
                margin: 14px 12px 0 12px;
                gap: 6px;
            }
            .mobile-switch-btn {
                background: #23242a;
                color: #fff;
                border: none;
                border-radius: 8px;
                padding: 6px 10px;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
            }
            .mobile-switch-btn.active {
                background: #00ff88;
                color: #0a0e17;
            }
            .mobile-token-chart {
                background: #23242a;
                border-radius: 14px;
                margin: 14px 12px 0 12px;
                padding: 12px 0 0 0;
                position: relative;
                height: 130px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-end;
            }
            .mobile-token-chart-label {
                position: absolute;
                top: 10px;
                right: 18px;
                background: #16181e;
                color: #00ff88;
                font-size: 14px;
                font-weight: 600;
                border-radius: 6px;
                padding: 2px 8px;
            }
            .mobile-token-reactions {
                display: flex;
                justify-content: space-between;
                margin: 14px 12px 0 12px;
                gap: 8px;
            }
            .mobile-reaction {
                background: #23242a;
                color: #fff;
                border-radius: 8px;
                padding: 7px 18px;
                font-size: 15px;
                display: flex;
                align-items: center;
                gap: 7px;
                font-weight: 500;
            }
            .mobile-token-actions {
                display: flex;
                justify-content: space-between;
                margin: 18px 12px 0 12px;
                gap: 12px;
            }
            .mobile-buy-btn {
                flex: 1;
                background: #00ff88;
                color: #0a0e17;
                border: none;
                border-radius: 12px;
                font-size: 18px;
                font-weight: 700;
                padding: 14px 0;
                margin-right: 4px;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            .mobile-sell-btn {
                flex: 1;
                background: #ff00b8;
                color: #fff;
                border: none;
                border-radius: 12px;
                font-size: 18px;
                font-weight: 700;
                padding: 14px 0;
                margin-left: 4px;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            .mobile-buy-btn:active, .mobile-sell-btn:active {
                opacity: 0.7;
                transform: scale(0.97);
                transition: transform 0.1s, opacity 0.1s;
            }
            /* Модальное окно */
            .mobile-modal-bg {
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.6);
                z-index: 4000;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .mobile-modal {
                background: #16181e;
                border-radius: 16px;
                padding: 28px 18px 18px 18px;
                min-width: 260px;
                max-width: 90vw;
                box-shadow: 0 4px 24px #0005;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            .mobile-modal-title {
                color: #fff;
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 12px;
            }
            .mobile-modal-input {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: none;
                background: #23242a;
                color: #fff;
                font-size: 16px;
                margin-bottom: 16px;
                outline: none;
            }
            .mobile-modal-btns {
                display: flex;
                gap: 10px;
                width: 100%;
            }
            .mobile-modal-btn {
                flex: 1;
                padding: 10px 0;
                border-radius: 8px;
                border: none;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: opacity 0.2s;
            }
            .mobile-modal-btn.confirm {
                background: #00ff88;
                color: #0a0e17;
            }
            .mobile-modal-btn.cancel {
                background: #23242a;
                color: #fff;
            }
        }

        /* === Скрытие мобильных блоков на десктопе === */
        @media (min-width: 769px) {
            .mobile-token-list, .mobile-exchange, .mobile-nav, #mobile-modal-root { display: none !important; }
            .container, header, .main-content { display: block; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">BLUMS</div>
            <nav>
                <a href="index.html">Биржа</a>
                <a href="wallet.html">Кошелек</a>
                <a href="memecoins.html">МемКоины</a>
            </nav>
        </header>

        <div class="main-content">
            <div class="tokens-list">
                <div class="token-item active" onclick="selectToken('BTC')">
                    <div class="token-info">
                        <span class="token-symbol">BTC</span>
                        <span class="token-price">$45,000</span>
                    </div>
                </div>
                <div class="token-item" onclick="selectToken('ETH')">
                    <div class="token-info">
                        <span class="token-symbol">ETH</span>
                        <span class="token-price">$3,200</span>
                    </div>
                </div>
                <div class="token-item" onclick="selectToken('SOL')">
                    <div class="token-info">
                        <span class="token-symbol">SOL</span>
                        <span class="token-price">$120</span>
                    </div>
                </div>
                <div class="token-item" onclick="selectToken('TON')">
                    <div class="token-info">
                        <span class="token-symbol">TON</span>
                        <span class="token-price">$2.5</span>
                    </div>
                </div>
                <div class="token-item" onclick="selectToken('TRON')">
                    <div class="token-info">
                        <span class="token-symbol">TRON</span>
                        <span class="token-price">$0.12</span>
                    </div>
                </div>
                <div class="token-item" onclick="selectToken('TRX')">
                    <div class="token-info">
                        <span class="token-symbol">TRX</span>
                        <span class="token-price">$0.08</span>
                    </div>
                </div>
                <div class="token-item" onclick="selectToken('FPIBANK')">
                    <div class="token-info">
                        <span class="token-symbol">FPIBANK</span>
                        <span class="token-price">$0.05</span>
                    </div>
                </div>
                <div class="token-item" onclick="selectToken('CHELDEVCOIN')">
                    <div class="token-info">
                        <span class="token-symbol">CHELDEVCOIN</span>
                        <span class="token-price">$0.03</span>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="priceChart" class="chart"></canvas>
                <div class="token-details">
                    <h2>BTC/USD</h2>
                    <div class="token-actions">
                        <button class="btn btn-buy" onclick="buyToken('BTC')">Купить</button>
                        <button class="btn btn-sell" onclick="sellToken('BTC')">Продать</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="index.html" class="mobile-nav-item active">
                <i class="fas fa-chart-line"></i>
                <span>Биржа</span>
            </a>
            <a href="wallet.html" class="mobile-nav-item">
                <i class="fas fa-wallet"></i>
                <span>Кошелек</span>
            </a>
            <a href="memecoins.html" class="mobile-nav-item">
                <i class="fas fa-coins"></i>
                <span>Мемкоины</span>
            </a>
        </div>
    </div>

    <!-- Мобильный список токенов -->
    <div class="mobile-token-list" style="display: block;">
        <div class="mobile-token-list-header">Токены</div>
        <div class="mobile-token-list-items">
            <div class="token-item" data-symbol="BTC">
                <div class="token-info">
                    <span class="token-symbol">BTC</span>
                    <span class="token-price">$45,000</span>
                </div>
            </div>
            <div class="token-item" data-symbol="ETH">
                <div class="token-info">
                    <span class="token-symbol">ETH</span>
                    <span class="token-price">$3,200</span>
                </div>
            </div>
            <div class="token-item" data-symbol="SOL">
                <div class="token-info">
                    <span class="token-symbol">SOL</span>
                    <span class="token-price">$120</span>
                </div>
            </div>
            <div class="token-item" data-symbol="TON">
                <div class="token-info">
                    <span class="token-symbol">TON</span>
                    <span class="token-price">$2.5</span>
                </div>
            </div>
            <div class="token-item" data-symbol="TRON">
                <div class="token-info">
                    <span class="token-symbol">TRON</span>
                    <span class="token-price">$0.12</span>
                </div>
            </div>
            <div class="token-item" data-symbol="TRX">
                <div class="token-info">
                    <span class="token-symbol">TRX</span>
                    <span class="token-price">$0.08</span>
                </div>
            </div>
            <div class="token-item" data-symbol="FPIBANK">
                <div class="token-info">
                    <span class="token-symbol">FPIBANK</span>
                    <span class="token-price">$0.05</span>
                </div>
            </div>
            <div class="token-item" data-symbol="CHELDEVCOIN">
                <div class="token-info">
                    <span class="token-symbol">CHELDEVCOIN</span>
                    <span class="token-price">$0.03</span>
                </div>
            </div>
        </div>
    </div>
    <!-- /Мобильный список токенов -->
    <!-- Мобильная биржа -->
    <div class="mobile-exchange" style="display: none;">
        <div class="mobile-topbar">
            <button class="mobile-back"><i class="fas fa-arrow-left"></i></button>
            <div class="mobile-title">Blum <span class="mobile-bot">bot</span></div>
            <div class="mobile-topbar-icons">
                <button class="mobile-topbar-btn"><i class="fas fa-ellipsis-h"></i></button>
            </div>
        </div>
        <div class="mobile-token-card">
            <div class="mobile-token-info">
                <img src="https://i.imgur.com/8Km9tLL.png" alt="$WAPE" class="mobile-token-avatar" id="mobile-token-avatar">
                <div>
                    <div class="mobile-token-name" id="mobile-token-name">$WAPE</div>
                    <div class="mobile-token-sub" id="mobile-token-sub">25 Nov • STON.fi</div>
                </div>
                <button class="mobile-share"><i class="fas fa-share"></i></button>
            </div>
            <div class="mobile-token-supply">
                <span class="mobile-token-percent" id="mobile-token-percent">15%</span>
                <span class="mobile-token-supply-numbers" id="mobile-token-supply">1374/9165 TON</span>
                <i class="fas fa-info-circle mobile-info"></i>
            </div>
        </div>
        <!-- Блок статистики -->
        <div class="mobile-token-stats">
            <div class="mobile-token-stats-row">
                <div class="mobile-token-stat">
                    <div class="mobile-token-stat-label">Market cap</div>
                    <div class="mobile-token-stat-value" id="mobile-marketcap">$7.5K</div>
                </div>
                <div class="mobile-token-stat">
                    <div class="mobile-token-stat-label">Holders</div>
                    <div class="mobile-token-stat-value" id="mobile-holders">6845</div>
                </div>
            </div>
            <div class="mobile-token-stats-row">
                <div class="mobile-token-stat">
                    <div class="mobile-token-stat-label">Txns</div>
                    <div class="mobile-token-stat-value" id="mobile-txns">1.5B</div>
                </div>
                <div class="mobile-token-stat">
                    <div class="mobile-token-stat-label">Volume</div>
                    <div class="mobile-token-stat-value" id="mobile-volume">$385,069,594</div>
                </div>
            </div>
        </div>
        <!-- Кнопки переключения -->
        <div class="mobile-token-switches">
            <button class="mobile-switch-btn active">MCap</button>
            <button class="mobile-switch-btn">Price</button>
            <button class="mobile-switch-btn">1m</button>
            <button class="mobile-switch-btn">5m</button>
            <button class="mobile-switch-btn">15m</button>
            <button class="mobile-switch-btn">1h</button>
        </div>
        <!-- График -->
        <div class="mobile-token-chart">
            <canvas id="mobilePriceChart" width="340" height="120"></canvas>
            <div class="mobile-token-chart-label" id="mobile-chart-label">$0.44</div>
        </div>
        <!-- Реакции -->
        <div class="mobile-token-reactions">
            <div class="mobile-reaction"><span>🚀</span> <span>8.1K</span></div>
            <div class="mobile-reaction"><span>🔥</span> <span>1.2K</span></div>
            <div class="mobile-reaction"><span>💔</span> <span>3.2K</span></div>
        </div>
        <!-- Кнопки Buy/Sell -->
        <div class="mobile-token-actions">
            <button class="mobile-buy-btn">Buy</button>
            <button class="mobile-sell-btn">Sell</button>
        </div>
    </div>
    <!-- /Мобильная биржа -->

    <div id="mobile-modal-root"></div>

    <script>
        // Инициализация данных в localStorage
        if (!localStorage.getItem('wallet')) {
            localStorage.setItem('wallet', JSON.stringify({
                balance: 0,
                tokens: {}
            }));
        }

        let currentToken = 'BTC';
        let canvas, ctx;
        let chartData = [];
        let chartInterval;

        let tokenPrices = JSON.parse(localStorage.getItem('tokenPrices')) || {
            'BTC': 45000,
            'ETH': 3200,
            'SOL': 120,
            'TON': 2.5,
            'TRON': 0.12,
            'TRX': 0.08,
            'FPIBANK': 0.05,
            'CHELDEVCOIN': 0.03
        };

        // Сохраняем начальные цены, если их еще нет в localStorage
        if (!localStorage.getItem('tokenPrices')) {
            localStorage.setItem('tokenPrices', JSON.stringify(tokenPrices));
        } else {
            // Гарантируем, что мемтокены есть в tokenPrices
            let prices = JSON.parse(localStorage.getItem('tokenPrices'));
            if (!prices['FPIBANK']) prices['FPIBANK'] = 0.05;
            if (!prices['CHELDEVCOIN']) prices['CHELDEVCOIN'] = 0.03;
            localStorage.setItem('tokenPrices', JSON.stringify(prices));
            tokenPrices = prices;
        }

        // Сохраняем историю цен для каждого токена
        let priceHistory = JSON.parse(localStorage.getItem('priceHistory')) || {};
        if (!localStorage.getItem('priceHistory')) {
            Object.keys(tokenPrices).forEach(symbol => {
                priceHistory[symbol] = [];
            });
            localStorage.setItem('priceHistory', JSON.stringify(priceHistory));
        }

        // Функции для работы с токенами
        function selectToken(symbol) {
            currentToken = symbol;
            document.querySelectorAll('.token-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            document.querySelector('.token-details h2').textContent = `${symbol}/USD`;
            updateChart();
        }

        function getTokenPrice(symbol) {
            return tokenPrices[symbol];
        }

        function updateTokenPrice(symbol, amount, isBuy) {
            const currentPrice = tokenPrices[symbol];
            let changePercent;
            
            if (isBuy) {
                changePercent = 1.2 + (amount / 100) * 4.1;
            } else {
                changePercent = 1 + (amount / 100) * 4;
            }
            
            const newPrice = isBuy 
                ? currentPrice * (1 + changePercent / 100)
                : currentPrice * (1 - changePercent / 100);
            
            tokenPrices[symbol] = newPrice;
            
            // Сохраняем новую цену в localStorage
            localStorage.setItem('tokenPrices', JSON.stringify(tokenPrices));
            
            // Добавляем новую цену в историю
            if (!priceHistory[symbol]) {
                priceHistory[symbol] = [];
            }
            priceHistory[symbol].push({
                price: newPrice,
                timestamp: Date.now()
            });
            
            // Оставляем только последние 100 значений
            if (priceHistory[symbol].length > 100) {
                priceHistory[symbol] = priceHistory[symbol].slice(-100);
            }
            
            // Сохраняем историю в localStorage
            localStorage.setItem('priceHistory', JSON.stringify(priceHistory));
            
            updateChart();
            return newPrice;
        }

        function buyToken(symbol) {
            const wallet = JSON.parse(localStorage.getItem('wallet'));
            const amount = prompt(`Сколько ${symbol} вы хотите купить?`);
            
            if (amount && !isNaN(amount)) {
                const price = getTokenPrice(symbol);
                const total = amount * price;
                
                // Обновляем цену после покупки
                const newPrice = updateTokenPrice(symbol, parseFloat(amount), true);
                
                wallet.balance -= total;
                wallet.tokens[symbol] = (wallet.tokens[symbol] || 0) + parseFloat(amount);
                localStorage.setItem('wallet', JSON.stringify(wallet));
                alert(`Успешно куплено ${amount} ${symbol} по цене $${price.toFixed(2)}. Новая цена: $${newPrice.toFixed(2)}`);
            }
        }

        function sellToken(symbol) {
            const wallet = JSON.parse(localStorage.getItem('wallet'));
            const amount = prompt(`Сколько ${symbol} вы хотите продать?`);
            
            if (amount && !isNaN(amount)) {
                if (wallet.tokens[symbol] >= parseFloat(amount)) {
                    const price = getTokenPrice(symbol);
                    const total = amount * price;
                    
                    // Обновляем цену после продажи
                    const newPrice = updateTokenPrice(symbol, parseFloat(amount), false);
                    
                    wallet.balance += total;
                    wallet.tokens[symbol] -= parseFloat(amount);
                    localStorage.setItem('wallet', JSON.stringify(wallet));
                    alert(`Успешно продано ${amount} ${symbol} по цене $${price.toFixed(2)}. Новая цена: $${newPrice.toFixed(2)}`);
                } else {
                    alert('Недостаточно токенов');
                }
            }
        }

        // Функции для работы с графиком
        function initChart() {
            canvas = document.getElementById('priceChart');
            ctx = canvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.offsetWidth - 40; // Учитываем padding
                canvas.height = container.offsetHeight - 140; // Учитываем высоту token-details
                updateChart();
            }
            
            // Инициализируем размеры
            resizeCanvas();
            
            // Обновляем размеры при изменении размера окна
            window.addEventListener('resize', resizeCanvas);
            
            // Обновляем график каждые 30 секунд
            chartInterval = setInterval(updateChart, 30000);
        }

        function generateChartData() {
            const data = [];
            const symbol = currentToken;
            
            // Используем сохраненную историю цен
            if (priceHistory[symbol] && priceHistory[symbol].length > 0) {
                return priceHistory[symbol].map(item => item.price);
            }
            
            // Если истории нет, генерируем начальные данные
            const basePrice = getTokenPrice(symbol);
            let lastPrice = basePrice;
            
            for (let i = 0; i < 100; i++) {
                const change = lastPrice * (Math.random() * 0.04 - 0.02);
                lastPrice = lastPrice + change;
                data.push(lastPrice);
            }
            return data;
        }

        function updateChart() {
            if (!canvas || !ctx) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            chartData = generateChartData();
            
            const min = Math.min(...chartData);
            const max = Math.max(...chartData);
            const range = max - min;
            
            // Рисуем сетку
            ctx.strokeStyle = '#2a2f3b';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 4; i++) {
                const y = (canvas.height / 4) * i;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            for (let i = 0; i <= 4; i++) {
                const x = (canvas.width / 4) * i;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            chartData.forEach((price, i) => {
                const x = (i / (chartData.length - 1)) * canvas.width;
                const y = canvas.height - ((price - min) / range) * canvas.height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            const currentPrice = chartData[chartData.length - 1];
            ctx.fillStyle = '#00ff88';
            ctx.font = '16px Arial';
            ctx.fillText(`Текущая цена: $${currentPrice.toFixed(2)}`, 10, 20);
            
            const priceChange = currentPrice - chartData[0];
            const percentChange = (priceChange / chartData[0]) * 100;
            ctx.fillStyle = priceChange >= 0 ? '#00ff88' : '#ff4444';
            ctx.fillText(`Изменение: ${percentChange.toFixed(2)}%`, 10, 45);
            
            // Обновляем список токенов
            updateTokenList();
        }

        // Обновляем цены в списке токенов
        function updateTokenList() {
            document.querySelectorAll('.token-item').forEach(item => {
                const symbol = item.querySelector('.token-symbol').textContent;
                const priceElement = item.querySelector('.token-price');
                priceElement.textContent = `$${tokenPrices[symbol].toFixed(2)}`;
            });
        }

        // Функция для случайного изменения цены и обновления графика
        function randomPriceUpdate() {
            const symbol = currentToken;
            let prices = JSON.parse(localStorage.getItem('tokenPrices')) || tokenPrices;
            let history = JSON.parse(localStorage.getItem('priceHistory')) || priceHistory;
            let price = prices[symbol];
            // Случайное изменение: вверх или вниз на 0.5-2%
            const direction = Math.random() > 0.5 ? 1 : -1;
            const percent = 0.5 + Math.random() * 1.5;
            price = price * (1 + direction * percent / 100);
            prices[symbol] = price;
            if (!history[symbol]) history[symbol] = [];
            history[symbol].push({ price, timestamp: Date.now() });
            if (history[symbol].length > 100) history[symbol] = history[symbol].slice(-100);
            localStorage.setItem('tokenPrices', JSON.stringify(prices));
            localStorage.setItem('priceHistory', JSON.stringify(history));
            tokenPrices = prices;
            priceHistory = history;
            updateChart();
        }

        // Инициализация при загрузке страницы
        window.onload = function() {
            // Инициализируем canvas
            canvas = document.getElementById('priceChart');
            ctx = canvas.getContext('2d');
            
            // Устанавливаем размеры canvas
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.offsetWidth - 40; // Учитываем padding
                canvas.height = container.offsetHeight - 140; // Учитываем высоту token-details
                updateChart();
            }
            
            // Инициализируем размеры
            resizeCanvas();
            
            // Обновляем размеры при изменении размера окна
            window.addEventListener('resize', resizeCanvas);
            
            // Обновляем график каждые 30 секунд
            chartInterval = setInterval(function() {
                randomPriceUpdate();
            }, 30000);
            
            // Обновляем список токенов
            updateTokenList();
        };

        // Удаляем старый обработчик resize
        window.onresize = null;

        // --- Мобильная логика ---
        function showMobileTokenCard(symbol) {
            // Здесь можно добавить реальные данные для каждого токена
            var tokenData = {
                'BTC': {
                    avatar: 'https://cryptologos.cc/logos/bitcoin-btc-logo.png',
                    name: 'BTC',
                    sub: 'Bitcoin • Spot',
                    percent: '+2.1%',
                    supply: '21000/21000000 BTC'
                },
                'ETH': {
                    avatar: 'https://cryptologos.cc/logos/ethereum-eth-logo.png',
                    name: 'ETH',
                    sub: 'Ethereum • Spot',
                    percent: '+1.3%',
                    supply: '120M/120M ETH'
                },
                'SOL': {
                    avatar: 'https://cryptologos.cc/logos/solana-sol-logo.png',
                    name: 'SOL',
                    sub: 'Solana • Spot',
                    percent: '+0.8%',
                    supply: '430M/500M SOL'
                },
                'TON': {
                    avatar: 'https://cryptologos.cc/logos/toncoin-ton-logo.png',
                    name: 'TON',
                    sub: 'TON • Spot',
                    percent: '+3.2%',
                    supply: '1374/9165 TON'
                },
                'TRON': {
                    avatar: 'https://cryptologos.cc/logos/tron-trx-logo.png',
                    name: 'TRON',
                    sub: 'TRON • Spot',
                    percent: '+0.5%',
                    supply: '92B/100B TRON'
                },
                'TRX': {
                    avatar: 'https://cryptologos.cc/logos/tron-trx-logo.png',
                    name: 'TRX',
                    sub: 'TRON • Spot',
                    percent: '+0.5%',
                    supply: '92B/100B TRX'
                },
                'FPIBANK': {
                    avatar: 'https://i.imgur.com/8Km9tLL.png',
                    name: 'FPIBANK',
                    sub: 'Memecoin • Spot',
                    percent: '+10%',
                    supply: '1M/10M FPIBANK'
                },
                'CHELDEVCOIN': {
                    avatar: 'https://i.imgur.com/8Km9tLL.png',
                    name: 'CHELDEVCOIN',
                    sub: 'Memecoin • Spot',
                    percent: '+7%',
                    supply: '500K/1M CHELDEVCOIN'
                }
            };
            var data = tokenData[symbol] || tokenData['BTC'];
            document.getElementById('mobile-token-avatar').src = data.avatar;
            document.getElementById('mobile-token-name').textContent = data.name;
            document.getElementById('mobile-token-sub').textContent = data.sub;
            document.getElementById('mobile-token-percent').textContent = data.percent;
            document.getElementById('mobile-token-supply').textContent = data.supply;
            document.querySelector('.mobile-exchange').style.display = 'block';
            document.querySelector('.mobile-token-list').style.display = 'none';
        }

        // Для мобильных: обработка клика по токену
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth <= 768) {
                // По умолчанию показываем только список токенов
                document.querySelector('.mobile-token-list').style.display = 'block';
                document.querySelector('.mobile-exchange').style.display = 'none';
                // Навешиваем обработчик только на мобильные токены
                document.querySelectorAll('.mobile-token-list .token-item').forEach(item => {
                    item.onclick = function() {
                        var symbol = this.getAttribute('data-symbol');
                        console.log('Токен выбран:', symbol);
                        showMobileTokenCard(symbol);
                        document.querySelector('.mobile-token-list').style.setProperty('display', 'none', 'important');
                        document.querySelector('.mobile-exchange').style.setProperty('display', 'block', 'important');
                        setTimeout(animateMobileChart, 100);
                    };
                });
                // Кнопка назад
                document.querySelector('.mobile-back').onclick = function() {
                    document.querySelector('.mobile-exchange').style.setProperty('display', 'none', 'important');
                    document.querySelector('.mobile-token-list').style.setProperty('display', 'block', 'important');
                };
            }
        });

        // --- Мобильный график (заглушка) ---
        function drawMobileChart() {
            var canvas = document.getElementById('mobilePriceChart');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Рисуем простую линию (пример)
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(10, canvas.height - 30);
            ctx.lineTo(canvas.width / 2, 30);
            ctx.lineTo(canvas.width - 10, canvas.height - 50);
            ctx.stroke();
        }

        // Рисуем график при открытии биржи
        if (window.innerWidth <= 768) {
            document.querySelectorAll('.mobile-token-list .token-item').forEach(item => {
                item.addEventListener('click', function() {
                    setTimeout(drawMobileChart, 100); // небольшой таймаут для отрисовки
                });
            });
        }

        // --- Анимация графика ---
        function animateMobileChart() {
            var canvas = document.getElementById('mobilePriceChart');
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Генерируем точки
            var points = [
                {x: 10, y: canvas.height - 30},
                {x: canvas.width / 2, y: 30},
                {x: canvas.width - 10, y: canvas.height - 50}
            ];
            var steps = 60;
            var current = 0;
            function drawStep() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                // Линейная интерполяция между точками
                var t = current / steps;
                var x1 = points[0].x + (points[1].x - points[0].x) * t;
                var y1 = points[0].y + (points[1].y - points[0].y) * t;
                ctx.lineTo(x1, y1);
                if (t > 0.5) {
                    var t2 = (t - 0.5) * 2;
                    var x2 = points[1].x + (points[2].x - points[1].x) * t2;
                    var y2 = points[1].y + (points[2].y - points[1].y) * t2;
                    ctx.lineTo(x2, y2);
                }
                ctx.stroke();
                if (current < steps) {
                    current++;
                    requestAnimationFrame(drawStep);
                }
            }
            drawStep();
        }

        // --- Модальное окно для покупки/продажи ---
        function showMobileModal(type, symbol) {
            var root = document.getElementById('mobile-modal-root');
            var title = type === 'buy' ? 'Покупка ' + symbol : 'Продажа ' + symbol;
            root.innerHTML = `
                <div class='mobile-modal-bg'>
                    <div class='mobile-modal'>
                        <div class='mobile-modal-title'>${title}</div>
                        <input class='mobile-modal-input' id='mobile-modal-amount' type='number' min='0' placeholder='Количество'>
                        <div class='mobile-modal-btns'>
                            <button class='mobile-modal-btn confirm'>OK</button>
                            <button class='mobile-modal-btn cancel'>Отмена</button>
                        </div>
                    </div>
                </div>
            `
        }
    </script>
</body>
</html>