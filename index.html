<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Крипто Биржа Blums</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      body {
          font-family: Arial, sans-serif;
          background-color: #121212;
          color: #ffffff;
          margin: 0;
          padding: 10px;
      }
      header {
          background: #1e1e1e;
          color: #ffffff;
          padding: 15px 0;
          text-align: center;
      }
      .container {
          display: flex;
          flex-direction: column;
          max-width: 1200px;
          margin: auto;
          background: #1e1e1e;
          border-radius: 5px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      }
      .sidebar {
          padding: 15px;
          border-bottom: 1px solid #333;
      }
      .token {
          margin: 10px 0;
          padding: 10px;
          border: 1px solid #444;
          border-radius: 5px;
          background: #2a2a2a;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          cursor: pointer; /* Указатель для интерактивных элементов */
      }
      .token:hover {
          background: #333;
      }
      .content {
          padding: 15px;
      }
      .button {
          background: #007bff;
          color: white;
          padding: 10px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          width: 100%;
          margin-top: 10px;
      }
      canvas {
          max-width: 100%;
          margin: 20px 0;
      }
      .input-group {
          margin: 10px 0;
          display: flex;
          flex-direction: column;
      }
      .balance {
          position: relative;
          background: rgba(0, 0, 0, 0.7);
          padding: 10px;
          border-radius: 5px;
          text-align: center;
          margin-bottom: 15px;
      }
      /* Стиль для модального окна */
      .modal {
          display: none; 
          position: fixed; 
          z-index: 1; 
          left: 0;
          top: 0;
          width: 100%; 
          height: 100%; 
          overflow: auto; 
          background-color: rgba(0, 0, 0, 0.8); 
          padding-top: 60px;
      }
      .modal-content {
          background-color: #2a2a2a;
          margin: 5% auto; 
          padding: 20px;
          border: 1px solid #888;
          width: 90%; 
          max-width: 400px;
          text-align: center;
      }
      .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
      }
      .close:hover,
      .close:focus {
          color: white;
          text-decoration: none;
          cursor: pointer;
      }
      @media (min-width: 600px) {
          .container {
              flex-direction: row;
          }
          .sidebar {
              width: 30%;
              border-right: 1px solid #333;
          }
          .content {
              width: 70%;
          }
          .button {
              width: auto;
          }
      }
  </style>
</head>
<body>
  <header>
      <h1>Крипто Биржа Blums</h1>
      <div class="balance">Баланс: $<span id="totalSpent">0.00</span></div>
  </header>
  <div class="container">
      <div class="sidebar">
          <h2>Доступные Токены</h2>
          <div id="tokenList"></div>
          
          <h2>Создать свой токен</h2>
          <input type="text" id="tokenName" placeholder="Название токена" />
          <button class="button" onclick="createToken()">Создать токен</button>
      </div>
      <div class="content">
          <h2>График цен токенов</h2>
          <canvas id="priceChart"></canvas>

          <h2>Регулирование графика</h2>
          <div class="input-group">
              <input type="number" id="tokenAmount" placeholder="Количество токенов" />
              <span id="tokenPrice" style="margin-left: 10px;">Цена: $<span id="priceValue">0</span></span>
          </div>
          <button class="button" onclick="buyToken()">Купить токен</button>
          <button class="button" onclick="sellToken()">Продать токен</button>
      </div>
  </div>

  <!-- Модальное окно -->
  <div id="myModal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <p id="modalMessage"></p>
          <button class="button" onclick="closeModal()">Закрыть</button>
      </div>
  </div>

  <script>
      const ctx = document.getElementById('priceChart').getContext('2d');

      // Функция для загрузки токенов из localStorage
      function loadTokens() {
          const storedTokens = Object.keys(localStorage).filter(key => key !== 'totalSpent');
          const tokenData = {};
          storedTokens.forEach(token => {
              tokenData[token] = JSON.parse(localStorage.getItem(token));
          });
          return tokenData;
      }

      let tokenData = loadTokens(); // Загружаем токены из localStorage
      let currentToken = 'BTC'; // Текущий токен
      let totalSpent = parseFloat(localStorage.getItem('totalSpent')) || 0; // Общая сумма потраченных USD

      // Зарезервированные токены
      const reservedTokens = ['BTC', 'ETH', 'SOL', 'FPIBANK', 'TON'];

      // Инициализируем график
      const priceChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: Array.from({length: tokenData[currentToken]?.length || 0}, (_, i) => (i + 1).toString()),
              datasets: [{
                  label: `Цена токенов (${currentToken})`,
                  data: tokenData[currentToken] || [],
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 2,
                  fill: false
              }]
          },
          options: {
              responsive: true,
              scales: {
                  y: {
                      beginAtZero: true,
                      grid: {
                          color: '#444'
                      }
                  },
                  x: {
                      grid: {
                          color: '#444'
                      }
                  }
              }
          }
      });

      function createToken() {
          const tokenName = document.getElementById('tokenName').value.trim();

          if (tokenName && !tokenData[tokenName] && !reservedTokens.includes(tokenName)) {
              tokenData[tokenName] = [0.00000670]; // Начальная цена нового токена
              localStorage.setItem(tokenName, JSON.stringify(tokenData[tokenName])); // Сохраняем в локальное хранилище
              showModal(`Токен ${tokenName} создан!`);
              document.getElementById('tokenName').value = ''; // Очищаем поле ввода

              // Обновляем список токенов и график
              updateTokenList();
              updateChartForNewToken(tokenName);
          } else if (reservedTokens.includes(tokenName)) {
              showModal(`Невозможно создать токен с названием ${tokenName}. Это зарезервированное имя.`);
          } else if (tokenData[tokenName]) {
              showModal('Токен с таким названием уже существует.');
          } else {
              showModal('Пожалуйста, введите корректное название токена.');
          }
      }

      function updateChartForNewToken(tokenName) {
          const newDataset = {
              label: `Цена токенов (${tokenName})`,
              data: tokenData[tokenName],
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 2,
              fill: false
          };
          priceChart.data.labels.push(...Array(tokenData[tokenName].length).fill('')); // Обновляем метки
          priceChart.data.datasets.push(newDataset); // Добавляем новый набор данных
          priceChart.update(); // Обновляем график
      }

      function updateTokenList() {
          const tokenList = document.getElementById('tokenList');
          tokenList.innerHTML = ''; // Очищаем текущий список

          // Добавляем зарезервированные токены
          reservedTokens.forEach(token => {
              const tokenDiv = document.createElement('div');
              tokenDiv.className = 'token';
              tokenDiv.textContent = `${token} (зарезервировано)`;
              
              // Кнопка удаления токена
              const deleteButton = document.createElement('button');
              deleteButton.textContent = 'Удалить';
              deleteButton.className = 'button';
              deleteButton.disabled = true; // Отключаем кнопку удаления для защищенных токенов
              
              tokenDiv.appendChild(deleteButton); // Добавляем кнопку удаления к токену
              tokenList.appendChild(tokenDiv);
          });

          // Добавляем пользовательские токены
          for (const token in tokenData) {
              const tokenDiv = document.createElement('div');
              tokenDiv.className = 'token';
              tokenDiv.textContent = `${token} (${tokenData[token][tokenData[token].length - 1]} USD)`;
              
              // Добавляем обработчик клика для переключения токенов
              tokenDiv.onclick = () => {
                  showTokenGraph(token);
              };

              // Кнопка удаления токена
              const deleteButton = document.createElement('button');
              deleteButton.textContent = 'Удалить';
              deleteButton.className = 'button';
              
              // Проверка на защищенные токены
              if (reservedTokens.includes(token)) {
                  deleteButton.disabled = true; // Отключаем кнопку удаления для защищенных токенов
                  deleteButton.title = "Удаление этого токена запрещено"; // Подсказка
              } else {
                  deleteButton.onclick = (e) => {
                      e.stopPropagation(); // Останавливаем всплытие события, чтобы не переключать токен
                      deleteToken(token); // Удаляем токен при нажатии
                  }; 
              }
              
              tokenDiv.appendChild(deleteButton); // Добавляем кнопку удаления к токену
              tokenList.appendChild(tokenDiv);
          }
      }

      function deleteToken(tokenName) {
          delete tokenData[tokenName]; // Удаляем токен из объекта
          localStorage.removeItem(tokenName); // Удаляем токен из localStorage
          showModal(`Токен ${tokenName} удален!`); // Показываем сообщение
          updateTokenList(); // Обновляем список токенов
          if (currentToken === tokenName) {
              currentToken = 'BTC'; // Сбрасываем текущий токен, если он был удалён
              priceChart.data.datasets = []; // Очищаем данные графика
              priceChart.update(); // Обновляем график
          }
      }

      function buyToken() {
          const amount = parseFloat(document.getElementById('tokenAmount').value);
          if (isNaN(amount) || amount < 0.000000001) {
              showModal('Пожалуйста, введите корректное количество токенов (минимум 0.000000001).');
              return;
          }
          const currentPrice = tokenData[currentToken][tokenData[currentToken].length - 1];
          const totalCost = amount * currentPrice;
          totalSpent += totalCost; // Обновляем общую сумму потраченных USD
          localStorage.setItem('totalSpent', totalSpent); // Сохраняем в локальное хранилище
          document.getElementById('totalSpent').innerText = totalSpent.toFixed(2); // Обновляем отображение

          tokenData[currentToken].push(currentPrice * (1 + (Math.random() * 0.05))); // Обновляем цену токена
          localStorage.setItem(currentToken, JSON.stringify(tokenData[currentToken])); // Сохраняем в локальное хранилище
          priceChart.update(); // Обновляем график
          document.getElementById('priceValue').innerText = totalCost.toFixed(2); // Обновляем цену
          showModal(`Вы купили ${amount} токенов за $${totalCost.toFixed(2)}.`);
      }

      function sellToken() {
          const amount = parseFloat(document.getElementById('tokenAmount').value);
          if (isNaN(amount) || amount < 0.000000001) {
              showModal('Пожалуйста, введите корректное количество токенов (минимум 0.000000001).');
              return;
          }
          const currentPrice = tokenData[currentToken][tokenData[currentToken].length - 1];
          const totalCost = amount * currentPrice;
          totalSpent -= totalCost; // Обновляем общую сумму потраченных USD
          localStorage.setItem('totalSpent', totalSpent); // Сохраняем в локальное хранилище
          document.getElementById('totalSpent').innerText = totalSpent.toFixed(2); // Обновляем отображение

          tokenData[currentToken].push(currentPrice * (1 - (Math.random() * 0.05))); // Обновляем цену токена
          localStorage.setItem(currentToken, JSON.stringify(tokenData[currentToken])); // Сохраняем в локальное хранилище
          priceChart.update(); // Обновляем график
          document.getElementById('priceValue').innerText = totalCost.toFixed(2); // Обновляем цену
          showModal(`Вы продали ${amount} токенов за $${totalCost.toFixed(2)}.`);
      }

      function showTokenGraph(token) {
          currentToken = token;
          const currentPrices = tokenData[currentToken];
          priceChart.data.labels = Array.from({length: currentPrices.length}, (_, i) => (i + 1).toString()); // Обновляем метки
          priceChart.data.datasets[0].data = currentPrices; // Обновляем данные графика
          priceChart.data.datasets[0].label = `Цена токенов (${currentToken})`; // Обновляем метку графика
          priceChart.update(); // Обновляем график
          document.getElementById('priceValue').innerText = currentPrices[currentPrices.length - 1].toFixed(2); // Обновляем отображение текущей цены
      }

      function showModal(message) {
          document.getElementById('modalMessage').innerText = message;
          document.getElementById('myModal').style.display = "block";
      }

      function closeModal() {
          document.getElementById('myModal').style.display = "none";
      }

      // Инициализация
      document.getElementById('totalSpent').innerText = totalSpent.toFixed(2); // Инициализируем отображение баланса
      updateTokenList(); // Инициализируем список токенов при загрузке
      showTokenGraph(currentToken); // Показываем график для текущего токена
  </script>
</body>
</html>