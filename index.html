<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crypto Exchange</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCtVA-P70pbJZTVtn3vFHsx1uCggeFf10c",
      authDomain: "blums-ebb54.firebaseapp.com",
      projectId: "blums-ebb54",
      storageBucket: "blums-ebb54.firebasestorage.app",
      messagingSenderId: "293233079310",
      appId: "1:293233079310:web:3b4f03d094130cbc92785f",
      measurementId: "G-ZE1BJKW80F"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const chartRef = doc(db, 'exchange', 'chartData');
    const priceRef = doc(db, 'exchange', 'prices');
    const userTokensRef = doc(db, 'exchange', 'userTokens');

    let prices = {};
    let chartData = {};
    let userTokens = [];
    let currentToken = "btc";

    async function saveChartData(data) {
      await setDoc(chartRef, data);
    }

    async function savePrices(prices) {
      await setDoc(priceRef, prices);
    }

    async function saveUserTokens(tokens) {
      await setDoc(userTokensRef, { tokens });
    }

    async function loadChartData() {
      const snap = await getDoc(chartRef);
      return snap.exists() ? snap.data() : {};
    }

    async function loadPrices() {
      const snap = await getDoc(priceRef);
      return snap.exists() ? snap.data() : {};
    }

    async function loadUserTokens() {
      const snap = await getDoc(userTokensRef);
      if (snap.exists()) {
        userTokens = snap.data().tokens || [];
      } else {
        userTokens = [];
      }
    }

    const defaultTokens = ["btc", "eth", "xrp", "sol", "ton", "link"];

    async function initializeDefaultTokens() {
      let updated = false;
      defaultTokens.forEach(token => {
        if (!prices[token]) {
          prices[token] = token === "btc" ? 100000 :
                          token === "eth" ? 1400 :
                          token === "xrp" ? 0.5 :
                          token === "sol" ? 20 :
                          token === "ton" ? 2 :
                          token === "link" ? 7 : 1;
          updated = true;
        }
        if (!chartData[token]) {
          chartData[token] = [prices[token]];
          updated = true;
        }
      });
      // И для пользовательских токенов
      userTokens.forEach(token => {
        if (!prices[token]) {
          prices[token] = 1; // Стандартная цена для юзерских токенов
          updated = true;
        }
        if (!chartData[token]) {
          chartData[token] = [prices[token]];
          updated = true;
        }
      });
      if (updated) {
        await savePrices(prices);
        await saveChartData(chartData);
      }
    }

    function initTokenButtons() {
      const container = document.getElementById("token-buttons");
      container.innerHTML = "";
      [...defaultTokens, ...userTokens].forEach(token => {
        const btn = document.createElement("button");
        btn.textContent = token.toUpperCase();
        btn.onclick = () => setCurrentToken(token);
        container.appendChild(btn);
      });
    }

    function updatePriceUI() {
      const info = document.getElementById("token-info");
      if (currentToken && prices[currentToken] != null) {
        info.innerText = `${currentToken.toUpperCase()}: $${prices[currentToken].toFixed(2)}`;
      } else {
        info.innerText = "Нет данных";
      }
    }

    function updateChartUI() {
      const ctx = document.getElementById("chart").getContext("2d");
      if (window.myChart) window.myChart.destroy();
      const data = chartData[currentToken] || [prices[currentToken] || 0];
      window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map((_, i) => i),
          datasets: [{
            label: `${currentToken.toUpperCase()} Price`,
            data: data,
            borderColor: '#0f0',
            backgroundColor: 'transparent'
          }]
        },
        options: {
          scales: {
            x: { display: false },
            y: { beginAtZero: false }
          },
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    window.setCurrentToken = function(token) {
      currentToken = token;
      updatePriceUI();
      updateChartUI();
    };

    window.addCustomToken = async function() {
      const input = document.getElementById("newToken");
      const token = input.value.trim().toLowerCase();
      if (!token) return alert("Введите название токена");
      if (defaultTokens.includes(token) || userTokens.includes(token)) {
        alert("Токен уже существует");
        return;
      }
      userTokens.push(token);
      prices[token] = 1;
      chartData[token] = [1];
      await saveUserTokens(userTokens);
      await savePrices(prices);
      await saveChartData(chartData);
      initTokenButtons();
      setCurrentToken(token);
      input.value = "";
    };

    window.removeCurrentToken = async function() {
      if (defaultTokens.includes(currentToken)) {
        alert("Нельзя удалять системные токены");
        return;
      }
      if (!userTokens.includes(currentToken)) {
        alert("Токен не найден в пользовательских");
        return;
      }
      userTokens = userTokens.filter(t => t !== currentToken);
      delete prices[currentToken];
      delete chartData[currentToken];
      await saveUserTokens(userTokens);
      await savePrices(prices);
      await saveChartData(chartData);
      currentToken = defaultTokens[0];
      initTokenButtons();
      setCurrentToken(currentToken);
    };

    // Инициализация приложения
    async function initializeAppData() {
      prices = await loadPrices();
      chartData = await loadChartData();
      await loadUserTokens();
      await initializeDefaultTokens();
      initTokenButtons();
      setCurrentToken(currentToken);
    }

    initializeAppData();

    // Подписка на обновления из Firestore
    onSnapshot(priceRef, (docSnap) => {
      if (docSnap.exists()) {
        prices = docSnap.data();
        updatePriceUI();
      }
    });

    onSnapshot(chartRef, (docSnap) => {
      if (docSnap.exists()) {
        chartData = docSnap.data();
        updateChartUI();
      }
    });

  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #111;
      color: white;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }
    .container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .sidebar {
      width: 200px;
      background-color: #222;
      padding: 20px;
      color: #fff;
      box-sizing: border-box;
    }
    .main {
      flex-grow: 1;
      padding: 20px;
      background-color: #333;
      position: relative;
      box-sizing: border-box;
    }
    #chart {
      width: 100%;
      height: 300px;
    }
    #token-buttons button {
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      background-color: #444;
      border: none;
      color: white;
      cursor: pointer;
    }
    #token-buttons button:hover {
      background-color: #555;
    }
    .token-info {
      margin: 20px 0;
      padding: 10px;
      background-color: #444;
      text-align: center;
      font-weight: bold;
      font-size: 1.2em;
    }
    .actions input {
      padding: 10px;
      width: 50px;
      background-color: #555;
      color: #fff;
      border: none;
      border-radius: 3px;
    }
    .actions button {
      padding: 10px;
      background-color: #444;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-left: 5px;
      border-radius: 3px;
    }
    .actions button:hover {
      background-color: #555;
    }
    .notifications {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ff6600;
      color: white;
      padding: 10px;
      border-radius: 5px;
      visibility: hidden;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div id="token-buttons"></div>
      <input type="text" id="newToken" placeholder="Новый токен" />
      <button onclick="addCustomToken()">Добавить токен</button>
      <button onclick="removeCurrentToken()">Удалить выбранный</button>
      <button onclick="toggleTheme()">Сменить тему</button>
      <button onclick="updateChart()">Обновить цену</button>
    </div>
    <div class="main">
      <canvas id="chart"></canvas>
      <div class="token-info" id="token-info">Выберите токен для просмотра цены</div>
      <div class="actions">
        <input type="number" id="amount" placeholder="Кол-во" />
        <button onclick="buyToken()">Купить</button>
        <button onclick="sellToken()">Продать</button>
      </div>
    </div>
  </div>
  <div class="notifications" id="notification"></div>
</body>
</html>
